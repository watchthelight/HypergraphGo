name: chocolatey

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (without v prefix, e.g. 1.6.0)'
        required: true
        type: string

permissions:
  contents: read

jobs:
  chocolatey:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          # Pull the repo just so scripts are available
          fetch-depth: 1

      - name: Set VERSION
        shell: pwsh
        run: |
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $ver = "${{ inputs.version }}"
          } else {
            $tag = "${{ github.event.release.tag_name }}"
            $ver = $tag -replace '^v',''
          }
          "VERSION=$ver" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          Write-Host "Resolved VERSION=$ver"

      # Do NOT install Chocolatey; it already exists on the GitHub Windows runner

      - name: Wait for checksums.txt to be available (max ~90s)
        shell: pwsh
        run: |
          $url = "https://github.com/${{ github.repository }}/releases/download/v$env:VERSION/checksums.txt"
          $ok = $false
          for ($i=0; $i -lt 30; $i++) {
            try {
              $resp = Invoke-WebRequest -Uri $url -UseBasicParsing -Method Head -TimeoutSec 10
              if ($resp.StatusCode -eq 200) { $ok = $true; break }
            } catch { Start-Sleep -Seconds 3 }
            Start-Sleep -Seconds 3
          }
          if (-not $ok) {
            Write-Error "checksums.txt not found at $url after waiting."
            exit 1
          }

      - name: Generate & push Chocolatey package
        shell: pwsh
        env:
          CHOCOLATEY_API_KEY: ${{ secrets.CHOCOLATEY_API_KEY }}
        run: |
          .\scripts\gen-choco.ps1 -Version $env:VERSION
