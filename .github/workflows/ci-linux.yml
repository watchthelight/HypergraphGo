name: CI (Linux)
on:
  push:
  pull_request:
permissions:
  contents: read

jobs:
  test-linux:
    name: test (ubuntu-latest)
    runs-on: ubuntu-latest
    env:
      GOTOOLCHAIN: local
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25.x'

      - name: Show module state
        run: |
          echo "PWD=$(pwd)"
          echo "GOMOD=$(go env GOMOD)"
          ls -la

      - name: Tidy, download, verify modules
        run: |
          go mod tidy
          go mod download all || true
          go mod verify

      - name: Build
        run: go build ./...

      - name: Vet
        run: go vet ./...

      - name: Test with race detection
        run: go test -race -v ./...

      - name: Test with coverage
        run: go test ./... -count=1 -v -coverprofile=coverage.out

      - name: Test cubical features
        run: go test -v -tags cubical ./...

      - name: Coverage summary
        run: |
          total=$(go tool cover -func=coverage.out | tail -n1 | awk '{print $3}')
          echo "Linux total coverage: $total" | tee -a "$GITHUB_STEP_SUMMARY"

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-linux
          path: coverage.out
